<!-- When integrating to React.js + Vite, use the hooks useEffect to fetch API call and useState to store the data from API callis  -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TTC Subway Map</title>

<!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100vh; /* full-page map */
      width: 100%;
    }

    .station-label span {
        font-size: 12px;
        font-weight: 600;
        color: black;
        background: white;
        padding: 2px 4px;
        border-radius: 4px;
        box-shadow: 0 0 2px rgba(0,0,0,0.3);
        white-space: nowrap;
    }

    .building-shape {
        width: 20px;
        height: 20px;
        background: linear-gradient(to bottom, #d32f2f, #b71c1c);
        border: 1px solid #880e4f;
        box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
        transform: perspective(40px) rotateX(30deg);
        border-radius: 2px;
    }

  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const x = document.getElementById("demo");

    function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(success, error);
    } else { 
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
    }

    function success(position) {
    x.innerHTML = "Latitude: " + position.coords.latitude + 
    "<br>Longitude: " + position.coords.longitude;
    }

    function error() {
    alert("Sorry, no position available.");
    }

    // alert("Hello, world!");

    // Initialize map centered on Toronto
    const map = L.map("map").setView([43.7, -79.38], 12);

    // Map
    L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
    {
        maxZoom: 19,
        attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
    }
    ).addTo(map);

    // TTC Line 1 with marker control
    const line1 = [
        { lat: 43.780041, lon: -79.415403, name: "Finch", showMarker: true },  
        { lat: 43.768561, lon: -79.412469, name: "North York Centre", showMarker: true },   
        { lat: 43.761652, lon: -79.412003, name: "Sheppard-Yonge", showMarker: true },   
        { lat: 43.744541, lon: -79.406403, name: "York Mills", showMarker: true },   
        { lat: 43.725327, lon: -79.402048, name: "Lawrence", showMarker: true },   
        { lat: 43.706069, lon: -79.398549, name: "Eglinton", showMarker: true },   
        { lat: 43.698, lon: -79.396966, name: "Davisville", showMarker: true },      
        { lat: 43.688196, lon: -79.39282, name: "St Clair", showMarker: true },    
        { lat: 43.682271, lon: -79.390781, name: "Summerhill", showMarker: true },    
        { lat: 43.676661, lon: -79.389144, name: "Rosedale", showMarker: true },   
        { lat: 43.670469, lon: -79.38658, name: "Bloor-Yonge", showMarker: true },    
        { lat: 43.665401, lon: -79.38466, name: "Wellesley", showMarker: true },   
        { lat: 43.661521, lon: -79.382723, name: "College", showMarker: true },   
        { lat: 43.656319, lon: -79.380939, name: "Dundas", showMarker: true },   
        { lat: 43.652548, lon: -79.379172, name: "Queen", showMarker: true },   
        { lat: 43.649167, lon: -79.377874, name: "King", showMarker: true },   
        { lat: 43.647786, lon: -79.377499, showMarker: false},
        { lat: 43.647126, lon: -79.37765, showMarker: false},
        { lat: 43.646661, lon: -79.377725, showMarker: false},
        { lat: 43.646117, lon: -79.378583, showMarker: false},
        { lat: 43.645387, lon: -79.380536, name: "Union", showMarker: true },   
        { lat: 43.64545, lon: -79.383111, showMarker: false},
        { lat: 43.645644, lon: -79.383669, showMarker: false},
        { lat: 43.646622, lon: -79.384226, showMarker: false},
        { lat: 43.647646, lon: -79.384818, name: "St Andrew", showMarker: true },   
        { lat: 43.650882, lon: -79.386741, name: "Osgoode", showMarker: true },   
        { lat: 43.654845, lon: -79.388356, name: "St Patrick", showMarker: true },   
        { lat: 43.659925, lon: -79.390539, name: "Queen's Park", showMarker: true },   
        { lat: 43.665849, lon: -79.392938, name: "Museum", showMarker: true},
        { lat: 43.668208, lon: -79.393979, showMarker: false},
        { lat: 43.668509, lon: -79.394291, showMarker: false},
        { lat: 43.668511, lon: -79.394891, showMarker: false},
        { lat: 43.667541, lon: -79.399815, name: "St George", showMarker: true},
        { lat: 43.66678, lon: -79.403635, name: "Spadina", showMarker: true},
        { lat: 43.666854, lon: -79.40391, showMarker: false},
        { lat: 43.674836, lon: -79.407132, name: "Dupont", showMarker: true},     
        { lat: 43.682028, lon: -79.410051, showMarker: false},   
        { lat: 43.682579, lon: -79.410705, showMarker: false},
        { lat: 43.682758, lon: -79.411864, showMarker: false},
        { lat: 43.682866, lon: -79.413784, showMarker: false},
        { lat: 43.683381, lon: -79.414647, showMarker: false},
        { lat: 43.684902, lon: -79.415664, name: "St Clair West", showMarker: true},   
        { lat: 43.688052, lon: -79.417767, showMarker: false},
        { lat: 43.688781, lon: -79.418561, showMarker: false},
        { lat: 43.689511, lon: -79.420127, showMarker: false},
        { lat: 43.690472, lon: -79.424698, showMarker: false},
        { lat: 43.690876, lon: -79.429054, showMarker: false},
        { lat: 43.694196, lon: -79.432852, showMarker: false},
        { lat: 43.698943, lon: -79.436135, name: "Eglinton West", showMarker: true},
        { lat: 43.709528, lon: -79.44125, name: "Glencairn", showMarker: true}, 
        { lat: 43.716088, lon: -79.444233, name: "Lawerence West", showMarker: true},       
        { lat: 43.724923, lon: -79.447636, name: "Yorkdale", showMarker: true},       
        { lat: 43.734319, lon: -79.450018, name: "Wilson", showMarker: true},   
        { lat: 43.740119, lon: -79.452283, showMarker: false},
        { lat: 43.743964, lon: -79.457175, showMarker: false},
        { lat: 43.747622, lon: -79.462067, showMarker: false},
        { lat: 43.750194, lon: -79.463343, name: "Sheppard West", showMarker: true},
        { lat: 43.752125, lon: -79.464068, showMarker: false},
        { lat: 43.753439, lon: -79.465793, showMarker: false},
        { lat: 43.754285, lon: -79.469029, showMarker: false},     
        { lat: 43.754927, lon: -79.471415, showMarker: false},
        { lat: 43.753563, lon: -79.479097, name: "Downsview", showMarker: true},
        { lat: 43.753098, lon: -79.482401, showMarker: false},
        { lat: 43.753501, lon: -79.485663, showMarker: false},
        { lat: 43.755423, lon: -79.487766, showMarker: false},
        { lat: 43.759204, lon: -79.489869, showMarker: false},
        { lat: 43.763482, lon: -79.490899, name: "Finch West", showMarker: true},
        { lat: 43.770734, lon: -79.493216, showMarker: false},
        { lat: 43.772314, lon: -79.494675, showMarker: false},
        { lat: 43.773762, lon: -79.500141, name: "York University", showMarker: true},
        { lat: 43.777751, lon: -79.512972, name: "Pioneer Village", showMarker: true},
        { lat: 43.779627, lon: -79.521969, showMarker: false},
        { lat: 43.780638, lon: -79.523764, showMarker: false},
        { lat: 43.782447, lon: -79.525188, name: "Highway 407", showMarker: true},
        { lat: 43.794149, lon: -79.528304, name: "Vaughan Metropolitan Centre", showMarker: true},
    ];

    // Draw the smooth gold polyline
    // L.polyline(line1.map(p => [p.lat, p.lon]), {
    //     color: "gold",
    //     weight: 5,
    //     opacity: 0.4,
    //      smoothFactor: 2
    // }).addTo(map);

    // Add circle markers only for real stations + station name 
    // line1.forEach(p => {
    // if (p.showMarker) {
    //     const marker = L.circleMarker([p.lat, p.lon], {
    //     radius: 4,
    //     color: "black",
    //     fillColor: "white",
    //     fillOpacity: 1,
    //     }).addTo(map);

    //     // add a small text label next to the marker
    //     L.marker([p.lat, p.lon], {
    //     icon: L.divIcon({
    //         className: "station-label",
    //         html: `<span>${p.name}</span>`,
    //         iconSize: [0, 0],
    //     }),
    //     }).addTo(map);
    // }
    // });

    L.polyline(line1.map(p => [p.lat, p.lon]), {
    color: "gold",
    weight: 5,
    opacity: 0.4,
    smoothFactor: 1.5,
    }).addTo(map);

    // add markers + popups
    line1.forEach(p => {
    if (p.showMarker) {
        L.circleMarker([p.lat, p.lon], {
        radius: 4,
        color: "black",
        fillColor: "white",
        fillOpacity: 1,
        })
        .bindPopup(`<b>${p.name}</b>`)
        .addTo(map);
    }
    });

    // TTC Line 2
    const line2 = [
        { lat: 43.637448, lon: -79.536127, name: "Kipling", showMarker: true},
        { lat: 43.645088, lon: -79.526214, showMarker: false},
        { lat: 43.645457, lon: -79.524077, name: "Islington", showMarker: true},
        { lat: 43.648027, lon: -79.511191, name: "Royal York", showMarker: true},
        { lat: 43.645088, lon: -79.526214, showMarker: false},
        { lat: 43.650376, lon: -79.499227, showMarker: false},
        { lat: 43.650252, lon: -79.497285, showMarker: false},
        { lat: 43.649813, lon: -79.49498, name: "Old Mill", showMarker: true},
        { lat: 43.648501, lon: -79.491397, showMarker: false},
        { lat: 43.647942, lon: -79.489283, showMarker: false},
        { lat: 43.647942, lon: -79.487234, showMarker: false},
        { lat: 43.648249, lon: -79.486095, showMarker: false},
        { lat: 43.649336, lon: -79.484797, showMarker: false},
        { lat: 43.649657, lon: -79.484262, name: "Jane", showMarker: true},
        { lat: 43.651816, lon: -79.475913, name: "Runnymede", showMarker: true},
        { lat: 43.65359, lon: -79.466203, name: "High Park", showMarker: true},
        { lat: 43.655205, lon: -79.459605, name: "Keele", showMarker: true},
        { lat: 43.656757, lon: -79.452825, name: "Dundas West", showMarker: true},
        { lat: 43.658931, lon: -79.442461, name: "Lansdowne", showMarker: true},
        { lat: 43.66211, lon: -79.426331, name: "Ossington", showMarker: true},
        { lat: 43.663854, lon: -79.418473, name: "Christie", showMarker: true},
        { lat: 43.665701, lon: -79.411156, name: "Bathurst", showMarker: true},
        { lat: 43.66678, lon: -79.403635, name: "Spadina", showMarker: true},
        { lat: 43.667541, lon: -79.399815, name: "St George", showMarker: true},
        { lat: 43.670063, lon: -79.389891, name: "Bay", showMarker: true},
        { lat: 43.670469, lon: -79.38658, name: "Bloor-Yonge", showMarker: true },    
        { lat: 43.672254, lon: -79.376504, name: "Sherbourne", showMarker: true },    

    ];

    L.polyline(line2.map(p => [p.lat, p.lon]), {
        color: "green",
        weight: 5,
        opacity: 0.4,
         smoothFactor: 2
    }).addTo(map);

    // line2.forEach(p => {
    // if (p.showMarker) {
    //     const marker = L.circleMarker([p.lat, p.lon], {
    //     radius: 4,
    //     color: "black",
    //     fillColor: "white",
    //     fillOpacity: 1,
    //     }).addTo(map);

    //     // add a small text label next to the marker
    //     L.marker([p.lat, p.lon], {
    //     icon: L.divIcon({
    //         className: "station-label",
    //         html: `<span>${p.name}</span>`,
    //         iconSize: [0, 0],
    //     }),
    //     }).addTo(map);
    // }
    // });

    line2.forEach(p => {
    if (p.showMarker) {
        L.circleMarker([p.lat, p.lon], {
        radius: 4,
        color: "black",
        fillColor: "white",
        fillOpacity: 1,
        })
        .bindPopup(`<b>${p.name}</b>`)
        .addTo(map);
    }
    });

    // TTC Line 4
    const line4 = [
    ];
    L.polyline(line4, { color: "magenta", weight: 5, opacity: 0.9 }).addTo(map);
    line4.forEach(c => L.circleMarker(c, { radius: 4, color: "black", fillColor: "white", fillOpacity: 1 }).addTo(map));


    // Venue data
    const venues = [
        { name: "Scotiabank Arena", lat: 43.643369, lon: -79.379012, logo: "scotiabank.png" },
        { name: "Rogers Centre", lat: 43.641397, lon: -79.389054, logo: "rogerscentre.png" },
        { name: "Budweiser Stage", lat: 43.629221, lon: -79.415093, logo: "budweiser.png" },
        { name: "BMO Field", lat: 43.63329, lon: -79.418548, logo: "bmo.png" },
    ];

    function getScaledIcon(logoUrl, zoom) {
        const baseSize = 40 * (zoom / 14); // base scaling
        const img = new Image();
        img.src = logoUrl;

        // Default aspect ratio if image hasn't loaded yet
        let width = baseSize;
        let height = baseSize;

        // Once loaded, adjust height according to image aspect ratio
        img.onload = () => {
            const aspectRatio = img.width / img.height;
            width = baseSize * aspectRatio;
            height = baseSize;
        };

        return L.icon({
            iconUrl: logoUrl,
            iconSize: [width, height],
            iconAnchor: [width / 2, height],
            popupAnchor: [0, -height * 0.9],
        });
    }

    // Initialize markers with dynamic scaling
    const venueMarkers = venues.map(v => {
        const icon = getScaledIcon(v.logo, map.getZoom());
        const marker = L.marker([v.lat, v.lon], { icon })
            .bindPopup(`<b>${v.name}</b>`)
            .addTo(map);
        return { marker, v };
    });

    // Update icon size when zoom changes
    map.on('zoomend', () => {
        const zoom = map.getZoom();
        venueMarkers.forEach(({ marker, v }) => {
            marker.setIcon(getScaledIcon(v.logo, zoom));
        });
    });

  </script>
</body>
</html>
